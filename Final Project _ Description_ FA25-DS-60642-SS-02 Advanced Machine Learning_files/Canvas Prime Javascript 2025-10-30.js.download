// Canvas Prime Javascript
// October 22, 2025 
// Follow up to the fix for the People tool not loading.  
// Restores our Notre Dame customizations to the People tool.

// Beginning of eXplorance Blue javascript
var BLUE_CANVAS_SETUP = {
    connectorUrl: "https://nd.bluera.com/ndBlueConnector/",
    canvasAPI: window.location.origin,
    domainName: "com.explorance",
    consumerID: "4ka4tx4nLdejNUrQDGL9zA==",
    defaultLanguage: "en-us"
},
BlueCanvasJS = document.createElement("script");
BlueCanvasJS.setAttribute("type", "text/javascript");
BlueCanvasJS.setAttribute("src", "https://nd.bluera.com/ndBlueConnector//Scripts/Canvas/BlueCanvas.min.js");
document.getElementsByTagName("head")[0].appendChild(BlueCanvasJS);
// End of eXplorance Blue javascript


// Beginning of People Tool Configuration
$(document).ready(function () {
  // Only run this code on the People page
  const courseIdMatch = window.location.pathname.match(/^\/courses\/(\d+)\/users$/);
  const courseId = courseIdMatch ? courseIdMatch[1] : null;

  console.log("Course ID from URL:", courseId);
  console.log("ENV.COURSE_ID:", typeof ENV !== "undefined" ? ENV.COURSE_ID : "undefined");

  if (!courseId) {
    console.error("Course ID not found in URL. Exiting script.");
    return;
  }

  // Slight delay to ensure Canvas initializes fully
  setTimeout(() => {
    removeRoles();
    watchForModal();
  }, 500);
});

function removeRoles() {
  const rolesToRemove = [3, 10, 11, 4, 9, 7];
  const additionalRoles = [12, 5, 26, 32, 35, 6];

  rolesToRemove.forEach(role => {
    $(`#role_id option[value="${role}"]`).remove();
  });

  if (typeof ENV !== "undefined" && ENV.permissions && !ENV.permissions.manage_students) {
    additionalRoles.forEach(role => {
      $(`#role_id option[value="${role}"]`).remove();
    });
  }
}

function watchForModal() {
  const observer = new MutationObserver((mutations, obs) => {
    const modal = document.getElementById("add_people_modal");
    if (modal) {
      obs.disconnect(); // Prevent repeated triggers
      customizeModal();
    }
  });

  observer.observe(document.body, {
    childList: true,
    subtree: true,
    attributes: true,
  });
}

function customizeModal() {
  const watchResults = document.querySelector(
    'span > span > span > span > div[role="presentation"] > ul[role="listbox"]'
  );

  if (watchResults) {
    // Remove roles from "Add People" screen dropdown (fixed selectors)
    ['139'].forEach(roleId => {
      $(`ul[role="listbox"] li[data-value="${roleId}"]`).remove();
    });
  }

  if ($("#add_people_modal").length === 1 && $("#addPeople-NDDirLink").length === 0) {
    customizeAddPeopleForm();
  }

  toggleNextButton();

  // Listen for future changes in modal for dynamic interactions
  const innerObserver = new MutationObserver(toggleNextButton);
  innerObserver.observe(document.querySelector("#add_people_modal"), {
    childList: true,
    subtree: true,
  });
}

function customizeAddPeopleForm() {
  // Change "Login Id" to "NetID or LoginID"
  $('[for="peoplesearch_radio_unique_id"] span:nth-child(2)').text("NetID or LoginID");

  // Hide "SIS ID"
  $('[for="peoplesearch_radio_sis_user_id"]').hide();

  // Add ND Directory Link
  $(".addpeople__peoplesearch fieldset").after(`
    <div id='addPeople-NDDirLink' style='float: right; margin-top: 0.5rem;'>
      <a href='https://directory.nd.edu' target='_blank'>ND Directory</a>
    </div>
  `);

  // Add role warning
  const roleWarning = "<h6 id='addPeople-NDRoleWarning' style='display: none;'>Please select a role to continue</h6>";
  $('[for="peoplesearch_select_role"] span:first span:first').append(roleWarning);
}

function toggleNextButton() {
  const roleSelected = $("#peoplesearch_select_role").val() !== "";
  const textEntered = $(".addpeople__peoplesearch fieldset:nth-child(2) textarea").val() !== "";

  if (roleSelected && textEntered) {
    $("#addpeople_next").show();
  } else {
    $("#addpeople_next").hide();
  }

  if (!roleSelected) {
    $("#peoplesearch_select_role").css({
      border: "2px solid red",
      "border-radius": "4px",
    });
    $("#addPeople-NDRoleWarning").show();
  } else {
    $("#peoplesearch_select_role").css({
      border: "",
      "border-radius": "",
    });
    $("#addPeople-NDRoleWarning").hide();
  }
}
// End of People Tool Configuration


// Beginning of Yuja Panorama Tool Configuration
(async function() {
    const PANORAMA_SERVER_URL = 'https://panorama-api.yuja.com';
    const panoramaIdentifierKey = 'd4cda00c65d3d3d53c7a5861dce0bf0bddeeb92d793df64f69623b6c4bee3db2';
    const PANORAMA_CDN_URL = 'https://cdn-panorama.yuja.com';
    window.PANORAMA_SERVER_URL = PANORAMA_SERVER_URL;
    window.panoramaIdentifierKey = panoramaIdentifierKey;
    window.PANORAMA_CDN_URL = PANORAMA_CDN_URL;

    function loadScript(url) {
        const script = document.createElement('script');
        script.src = url;
        document.head.appendChild(script);
    }

    try {
        const response = await fetch(`${PANORAMA_SERVER_URL}/panorama-visualizer/canvas`, {
            cache: 'no-store'
        });
        const scriptUrl = await response.text();
        loadScript(scriptUrl);
    } catch (e) {
        console.error('Failed to load Panorama: ', e);
    }
})();
// End of Yuja Panorama Tool Configuration


// Begin add link to dashboard
// Adds a link to All Courses directly on the dashboard.  Helps users find future or concluded courses and reduced amount of tickets about "missing" courses at the end of a term.
var do_addcourselink = function(){
// Checks if page is dashboard
if (window.location.pathname=='/') {
document.getElementById('DashboardCard_Container').insertAdjacentHTML('beforebegin', '<div><h2 class="ic-DashboardCard__box__header"><a href="/courses"  style="color:rgb(20, 56, 101);">All Courses</a></h2><p></p><p>Any courses that are not shown below can be found on your <a href="/courses">All Courses</a> page. Star courses to keep them displayed on this dashboard.</p></div>');
}
}

if (document.readyState === "complete" || (document.readyState !== "loading" && !document.documentElement.doScroll)) {
do_addcourselink();
} else {
document.addEventListener("DOMContentLoaded", do_addcourselink);
}
//End add link to dashboard

////////////////////////////////////////////////////
// DESIGNPLUS CONFIG                            //
////////////////////////////////////////////////////
DpPrimary = {
    lms: 'canvas',
    templateCourse: '94410',
    hideButton: true,
    hideLti: false,
    extendedCourse: '', // added in sub-account theme
    sharedCourse: '', // added from localStorage
    courseFormats: [],
    canvasRoles: ['admin','teacher'],
    canvasUsers: [],
    canvasCourseIds: [],
    plugins: [],
    excludedModules: [],
    includedModules: [],
    lang: 'en',
}

// merge with extended/shared customizations config
DpConfig = { ...DpPrimary, ...(window.DpConfig ?? {}) }

$(function () {
    const uriPrefix = (location.href.includes('.beta.')) ? 'beta.' : '';
    const toolsUri = (DpConfig.toolsUri) ? DpConfig.toolsUri : `https://${uriPrefix}designplus.ciditools.com/`;
    $.getScript(`${toolsUri}js/controller.js`);
});
////////////////////////////////////////////////////
// END DESIGNPLUS CONFIG                        //
////////////////////////////////////////////////////

/* Custom JavaScript for Canva's Theme - Pria version 1.4 July 7th 2025 */
var priaStarted = window.priaStarted || false

//
// TODO: 
// 1- Leave the institution_id to an empty string (Digital Twin) so that teachers or administrators can create or select a new or existing instance of Pria (digital twin),
//    or set to a specific instance public id like ('5fd6d7a4-4cc7-4e04-8473-e89aef4e...') which will be used by default when launching Pria, 
//    When value is set to undefined, Pria will not load.
// 2- set the picture PNG/JPG accessible cross domains to change your logo, or leave undefined to keep Pria's default picture
// 3- customize display options or leave the default values.
// See install documentation at https://learning.praxislxp.com/praxis/pria-custom-theme-canvas-install-guide/
//
// Note: as of version 1.2 a new display option noUI is offered to disable the UI completely and interact with Pris programatically through the SDK 
// See Developer documentation at https://learning.praxislxp.com/praxis/pria-js-sdk/

var INSTITUTION_ID="";   // undefined, "", or valid ID "5fd6d7a4-4cc7-4e04-8473-e89aef4e...";
var INSTITUTION_ICON_URL; // undefined for default Pria logo or full url ex: "https://cdn.mydomain.com/assets/picture.png"
var DISPLAY_OPTIONS={
    fullScreen: false,    // True for expanded in full screen
    openOnLoad: false,    // True to open Pria immediately when loaded 
    buttonWidth: '80px',  // Size of the button containing the Pria Logo
    buttonPosition: 'fixed',     // Determine the position of the button (fixed, relative, sticky)
    buttonPositionRight: '60px', // Position of the button relative to the right edge of the screen
    buttonPositionBottom: '60px',// Position of the button relative to the bottom edge of the screen
    buttonNoBounce: true,  // Determine wether the button will not bounce when Pria is closed
    priaContainerId: '',   // Id of the container receiving pria window (default empty uses BODY)
    buttonContainerId: '', // Id of the container receiving the button (default empty uses BODY)
    allowPop: false, // true to show the button and pop Pria out the containing iFrame 
    noUI: false // true to disable the UI. Pria is still accessible through the Javascript SDK
}

window.addEventListener('load', (event) => {

    //
    // Code below determines when to start Pria 
    // By default on all course pages and theme editor for preview
    // Customize as needed
    //

   
    // load on all courses page (default)
    // Ex: https://praxis-ai.instructure.com/courses/106
    /* onPage(/\/courses\/\d+/, function (isOnPage) {
        if (isOnPage) {
            // Will not load on preview pages
            if (location.href.match(/preview=/)) return 
            */

            // Example on how to use the isInCourses functions to 
            // connect to a specific instance of pria, or enable digital twins 
            // when the INSTITUTION_ID is set to undefined on line 13
            /*
            var coursesForSpecificInstance = [79875, 72856, 55621]
            isInCourses(coursesForSpecificInstance, function (isCourse) {
                if (isCourse) {
                    INSTITUTION_ID='1234-5245-ss-aaa'
                    INSTITUTION_ICON_URL='https://cdn.domain.edu/my/icon.png'
                }
            })
            */

            
                var coursesForDigitalTwin = [    
                  104666 // Steve Varela (svarela3)             Praxis Pria Pilot Support
                , 109033 // Steve Varela (svarela3)             Teaching Well with AI Academy	
                , 126637 // Steve Varela (svarela3)             2025 Teaching Well with AI Academy 
                , 125815 // Steve Varela (svarela3)             FA25-ROSP-20602-CX-01  Monstruos y Miedo: Terror Power and Society in Latino and Latin American Film
                , 126570 // Steve Varela (svarela3)             Service Management
                , 128393 // Steve Varela (svarela3)             Notre Dame ServiceNow Fundamentals
                ,  94362 // Andrew Craker (acraker)             Praxis Pria Testing
                , 122377 // Bruce Lohman (blohman3)             FA25-RE-30830-CX-01  Real Estate Disruption: Proptech and Fintech
                , 125034 // Bruce Lohman (blohman3)             FA25-RE-30700-01 Foundations of Real Estate Finance
                , 123854 // Bruce Lohman (blohman3)             FA25-RE-43100-CX-01  Real Estate Colloquium: Finance Investment and Law
                , 119350 // Bahram Moasser (bmoasser)           FA25-CHEM-41443-01 Advanced Inorganic Chemistry Laboratory
                , 126492 // Vickie Woodard (vweber1)            ACMS Resources
                , 126619 // Christopher Frederick (cfreder2)    DS60502 Sandbox
                , 120788 // Jason Reed (jreed1)                 FA25-FIN-40610-01 Security Analysis
                ,  94053 // Jason Reed (jreed1)                 Private Equity Industry Readiness
                , 122211 // Keith Urtel (kurtel)                FA25-MSA-70121-SS-01  Fraud and Audit Analytics
                , 123763 // Keith Urtel (kurtel1)               FA25-ACCT-40130-01  Accounting for Mergers & Acquisitions
                , 122215 // Keith Urtel (kurtel1)               FA25-MSA-701140-CX-01  Acct for Mergers & Acquisitions
                , 121498 // Hope Hollocher (hholloch)           FA25-BIOS-10169-03 Biology 1: Big Questions Mod 1  
                , 121101 // Hope Hollocher (hholloch)           FA25-BIOS-10170-03  Biology 1: Big Questions Mod 2
                , 117376 // Laura Cira (lcira)                  SP25-CAN-10101-01
                , 121580 // Victoria Hui (thui)                 FA25-CSEM-23101-CX-25 College Seminar 
                , 121087 // Victoria Hui (thui)                 FA25-POLS-53001-CX-04  Senior Writing Seminar: Democracy Defenders in Exile
                , 125727 // Nathaniel Myers (nmyers3)           FA25-WR-23500-CX-01 Writing in the Age of AI
                , 121758 // Brandon Erlacher (berlache)         FA25-ITAO-30160-02 Conveying Visual Data Insights
                , 122813 // Brandon Erlacher (berlache)         FA25-ITAO-30160-01 Conveying Visual Data Insights
                , 125312 // Brandon Erlacher (berlache)         FA25-MBA-70321-CX-01 Conveying Visual Data Insights
                , 125313 // Brandon Erlacher (berlache)         FA25-MBA-70321-CX-02 Conveying Visual Data Insights
                , 125786 // Brandon Erlacher (berlache)         FA25-MBAE-60320-02 Conveying Visual Data Insights
                , 125808 // Brandon Erlacher (berlache)         FA25-MBAE-60320-01  Conveying Visual Data Insights
                , 123472 // Thomas O'Sullivan (tosuli2)         FA25-EE-Introduction to Biophotonics and Biomedical Optics
                , 127919 // Steve Reifenberg (sreifenb)         Sandbox for Team-Based Capstone Fall 2025
                , 126980 // Stephen Lancaster (slancast)        Diction Coach
                , 126981 // Stephen Lancaster (slancast)        Voice Teacher Assistant
                ,  56393 // Stephen Lancaster (slancast)        Performance Video Creation for Musicians
                , 127922 // Oscar Gonzalez (ogonzal1)           Sandbox
                , 124790 // Elena Mangione-Lora (emangion)      FA25-ROSP-20202-SS-09  Intermediate Spanish II
                , 121131 // Paul Perrin (pperrin)               FA25-MGA-60008-01 Integration Lab III: Analysis & Strategy
                , 125320 // Sharif Nijim (snijim)               FA25-MBA-70359-SS-L5 Cloud Analytics
                , 104434 // Angela McCarthy (amccar22)          Department of Political Science 
    ]



            isInCourses(coursesForDigitalTwin, function (isCourse) {
                if (isCourse) {
                    INSTITUTION_ID=''
                    INSTITUTION_ICON_URL=undefined
                    loadPria()
                }
            })
            

            /*
            var coursesForAccounts = [123, 2345]
            isInAccounts(coursesForAccounts, function (isAccount) {
                if (isAccount) {
                    INSTITUTION_ID=''
                    INSTITUTION_ICON_URL=undefined
                }
            })
            

     }) */

    //
    // Additional loading options 
    //

    // load on theme_editor page
    // Ex: url https://praxis-ai.instructure.com/accounts/1/theme_editor
    onPage(/\/theme_editor/, function (isOnPage) {
        if (isOnPage) {
           loadPria()
        }
    })

    // load for a user role 
    // ex: user, teacher, admin, root_admin, etc.
    // hasAnyRole('user', function (hasRole) {
    //     if (hasRole) {
    //         // loadPria()
    //     }
    // })

    // load if a student
    /* isStudent(function (isStudent) {
        if (isStudent) {
            //  loadPria()
        }
    }) */

    // load for a specific user
    /* isUser(1, function (isUser) {
        if (isUser) {
            //  loadPria()
        }
    }) */ 
    
    // load for specific users
    /* var userIds=[1,2,3]
    isInUsers(userIds, function (isUser) {
        if (isUser) {
            //  loadPria()
        }
    }) */

    // load for a specific course
    /* isCourse(123, function (isCourse) {
        if (isCourse) {
            //  loadPria()
        }
    }) */ 

    /* var courseIds = [1234,2345]
    isInCourses(courseIds, function (isCourse) {
        if (isCourse) {
            //  loadPria()
        }
    }) */ 

    // Load with an action on a page using el (a jquery element collection)
    onElementRendered('a[href=#create_ticket]', function (el) {
        //  loadPria()
    })

})

//
// DO NOT MODIFY utility functions below
//
function onPage(regex, fn) {
    location.pathname.match(regex) ? fn(true) : fn(false)
}

function hasAnyRole(/*roles, cb*/) {
    var roles = [].slice.call(arguments, 0);
    var cb = roles.pop();
    for (var i = 0; i < arguments.length; i++) {
        if (ENV.current_user_roles !== null && ENV.current_user_roles.indexOf(arguments[i]) !== -1) {
            return cb(true)
        }
    }
    return cb(false)
}

function isUser(id, cb) {
    var currentUser = Number(ENV?.current_user_id || ENV?.current_user?._id)
    cb( currentUser === Number(id));
}

function isInUsers(ids, cb) {
    var currentUser = Number(ENV?.current_user_id || ENV?.current_user?._id)
    var res = ids.includes(currentUser)
    if (cb) {
        cb(res)
    }
    return res
}

function isCourse(id, cb) {
    let res = (ENV?.current_context?.id && Number(ENV.current_context?.id) === Number(id) && ENV?.current_context?.type==="Course") ||
    (ENV.COURSE_ID && Number(ENV.COURSE_ID) === Number(id))
    if (cb) {
        cb(res)
    }
    return res
}

function isInCourses(ids, cb) {
    let currentCourseId = (ENV?.current_context?.type==="Course" &&  ENV?.current_context?.id ? Number(ENV.current_context?.id) : (ENV?.COURSE_ID ? Number(ENV.COURSE_ID) : 0 ))
    var res = ids.includes(currentCourseId)
    if (cb) {
        cb(res)
    }
    return res
} 

function isAccount(id, cb) {
    let res = (ENV?.current_context?.id && ENV?.current_context?.type==="Course" && ENV.ACCOUNT_ID && Number(ENV.ACCOUNT_ID) === Number(id))
    if (cb) {
        cb(res)
    }
    return res
}

function isInAccounts(ids, cb) {
    let currentAccountId = (ENV?.current_context?.id && ENV?.current_context?.type==="Course" && ENV.ACCOUNT_ID ? Number(ENV.ACCOUNT_ID) : -1 )
    if (currentAccountId<=0) {
        cb(false)
        return false
    }

    var res = ids.includes(currentAccountId)
    if (cb) {
        cb(res)
    }
    return res
}

function isStudent(cb) {
    cb(ENV.current_user_is_student);
}

function onElementRendered(selector, cb, _attempts) {
    var el = $(selector)
    _attempts = ++_attempts || 1
    if (el.length) return cb(el)
    if (_attempts === 60) return
    setTimeout( () => {
        onElementRendered(selector, cb, _attempts);
    }, 250)
}


const loadPria = () => {
    if (priaStarted) return;
    priaStarted = true;
    var currentUser = ENV?.current_user_global_id || ENV?.current_user_id || ENV?.current_user?._id || 1
    
    var email = ENV?.current_user?.email || ENV?.USER_EMAIL || ""
    if (email.length === 0) {
        email =  `${currentUser}@${document.location.host}`
    }

    var isAdmin = ENV.current_user_roles?.indexOf('admin') > -1 || ENV.current_user_roles?.indexOf('teacher') > -1 || ENV.current_user_roles?.indexOf('root_admin') > -1 || ENV.current_user_is_admin || false;
    //console.info("Canvas ENV", ENV)
    var user = {
        email: email,
        profilename: ENV?.current_user?.display_name || "User Name",
        profilepicture: ENV?.current_user?.avatar_image_url || "",
        userid: `${currentUser}`,  /* external id of the user */
        usertype: isAdmin ? 4 : 1, /*1: user, 4: admin*/
        roleid: Number(ENV?.current_context?.id || ENV?.COURSE_ID || ENV?.COURSE?.id || 1),  /* Course ID when present (optional) */
        rolename:  ENV?.current_context?.name || ENV?.COURSE?.long_name || "", /* Course Name (optional)*/
        partnerid: `${ENV.DOMAIN_ROOT_ACCOUNT_ID || ENV.ACCOUNT_ID || 1}`, /* Account ID (optional) */
        partnername: document.location.host, /* Account domain (optional) */
        lticontextid : ENV?.current_context?.url || document.location.href, /* Placement of Pria */
    }

    loadSdkOver('https://pria.praxislxp.com', user, INSTITUTION_ID, INSTITUTION_ICON_URL, DISPLAY_OPTIONS)

}

const loadSdkOver = (u, user, key, icon, options) => {
    const script = document.createElement('script');
    script.src = u + "/pria-sdk.js";
    script.async = true;
    document.body.appendChild(script);
    script.onload = () => {
        if (typeof (window.priasdk) === 'function') {
            window.priasdk(u, user, key, icon, options);
        }
    }
}

// End of Praxis Pria configuration

// Student Sort Investigation Script
// Debugging function
function debug(message) {
  console.log(`%c[Student Sort Debug]: ${message}`, 'color: #4CAF50; font-weight: bold;');
}

// Function to check if we're on the correct grades page
function isCorrectGradesPage() {
  return /^\/courses\/\d+\/grades$/.test(window.location.pathname);
}

// Function to get the last name from a student name string
function getLastName(name) {
  const parts = name.split(',');
  return parts.length > 1 ? parts[0].trim() : name.split(' ').pop().trim();
}

// Global variable to track if sorting is in progress
let isSorting = false;

// Function to sort and update the student list
function sortStudentList() {
  if (isSorting) return;
  isSorting = true;
  debug('Attempting to sort student list');
  
  const inputElement = document.getElementById('student_select_menu');
  if (!inputElement) {
      debug('Student select input not found');
      isSorting = false;
      return;
  }

  // Trigger the dropdown to open
  inputElement.click();

  // Use a recursive function to wait for the listbox to appear
  function waitForListbox(attempts = 0) {
      const listbox = document.querySelector('[role="listbox"]');
      if (listbox) {
          const options = Array.from(listbox.querySelectorAll('[role="option"]'));
          debug(`Found ${options.length} options`);

          // Sort the options by last name
          options.sort((a, b) => {
              const lastNameA = getLastName(a.textContent.trim());
              const lastNameB = getLastName(b.textContent.trim());
              return lastNameA.localeCompare(lastNameB);
          });

          // Update the listbox with sorted options
          options.forEach(option => listbox.appendChild(option));

          debug('Options sorted and listbox updated');

          // Close the dropdown
          document.body.click();

          // Store the sorted order
          window.sortedStudentOptions = options.map(opt => opt.getAttribute('data-id'));
          isSorting = false;
      } else if (attempts < 10) {
          setTimeout(() => waitForListbox(attempts + 1), 100);
      } else {
          debug('Listbox not found after multiple attempts');
          isSorting = false;
      }
  }

  waitForListbox();
}

// Function to add the sort button
function addSortButton() {
  if (document.getElementById('sort-students-button')) {
      debug('Sort button already exists');
      return;
  }

  const inputElement = document.getElementById('student_select_menu');
  if (!inputElement) {
      debug('Cannot add sort button, input element not found');
      return;
  }

  // Find a suitable parent element to place the button above the dropdown
  let parentElement = inputElement.closest('.css-1iqa4xu-gridCol');
  if (!parentElement) {
      parentElement = inputElement.parentNode;
      debug('Ideal parent not found, using immediate parent');
  }

  const button = document.createElement('button');
  button.id = 'sort-students-button';
  button.textContent = 'Sort Students';
  button.style.marginBottom = '10px';
  button.style.display = 'block';
  button.onclick = sortStudentList;

  // Insert the button before the dropdown
  parentElement.insertBefore(button, inputElement);
  debug('Sort button added above the dropdown');
}

// Function to maintain sort order when dropdown is opened
function maintainSortOrder() {
  const observer = new MutationObserver((mutations) => {
      if (isSorting) return;
      mutations.forEach((mutation) => {
          if (mutation.type === 'childList') {
              const listbox = document.querySelector('[role="listbox"]');
              if (listbox && window.sortedStudentOptions && !isSorting) {
                  isSorting = true;
                  const options = Array.from(listbox.querySelectorAll('[role="option"]'));
                  const sortedOptions = window.sortedStudentOptions
                      .map(id => options.find(opt => opt.getAttribute('data-id') === id))
                      .filter(Boolean);
                  
                  sortedOptions.forEach(option => listbox.appendChild(option));
                  debug('Maintained sort order on dropdown open');
                  isSorting = false;
              }
          }
      });
  });

  const config = { childList: true, subtree: true };
  observer.observe(document.body, config);
}

// Function to initialize the sorting functionality
function initializeSorting() {
  if (!isCorrectGradesPage()) {
      debug('Not on the grades page, exiting');
      return;
  }

  debug('On grades page, setting up');

  // Wait for the page to fully load
  setTimeout(() => {
      addSortButton();
      maintainSortOrder();
  }, 1000); // Adjust this timeout if needed
}

// Run the initialization when the DOM is fully loaded
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeSorting);
} else {
  initializeSorting();
}

debug('Student sorting script loaded');